<!DOCTYPE html>
<html lang="en">

<head>
    <title>Thyaga Bot</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet"
        integrity="sha384-QWTKZyjpPEjISv5WaRU9OFeRpok6YctnYmDr5pNlyT2bRjXh0JMhjY6hW+ALEwIH" crossorigin="anonymous">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.min.css">
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link
        href="https://fonts.googleapis.com/css2?family=Poppins:ital,wght@0,100;0,200;0,300;0,400;0,500;0,600;0,700;0,800;0,900;1,100;1,200;1,300;1,400;1,500;1,600;1,700;1,800;1,900&display=swap"
        rel="stylesheet">
    <link rel="icon" href="favicon.png">
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"
        integrity="sha384-YvpcrYf0tY3lHB60NNkmXc5s9fDVZLESaAA55NDzOxhy9GkcIdslK1eN7N6jIeHz"
        crossorigin="anonymous"></script>
    <script src="https://cdn.jsdelivr.net/npm/@popperjs/core@2.11.8/dist/umd/popper.min.js"
        integrity="sha384-I7E8VVD/ismYTF4hNIPjVp/Zjvgyol6VFvRkX/vR+Vc4jQkC+hVqc2pM8ODewa9r"
        crossorigin="anonymous"></script>
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.min.js"
        integrity="sha384-0pUGZvbkm6XF6gxjEnlmuGrJXVbNuzT9qBBavbLwCsOGabYfZo0T0to5eqruptLy"
        crossorigin="anonymous"></script>
    <style>
        .container {
            width: 360px;
            position: absolute;
            bottom: 10px;
            right: 10px;
            border: none;
            border-radius: 8px;
        }

        .bot-message {
            padding: 10px;
            border-radius: 10px;
            margin-bottom: 10px;
            color: #595E62;
            display: flex;
            align-items: end;
            font-family: "Poppins", sans-serif;
            display: flex;
            flex-direction: row;
            justify-content: start;
            align-items: start;
        }

        .bot-message .messageWrapper div {
            border: none;
            border-radius: 8px;
            max-width: 280px;
            /* width: max-content; */
            padding: 10px;
            border-top-left-radius: 0px;
            font-size: 12px;
            background-color: #1C73D4;
            color: #fff !important;
            display: flex;
            flex-direction: column;
            /* box-shadow: 0 0.125rem 0.25rem rgba(0, 0, 0, 0.075); */
        }

        .user-message {
            padding: 10px;
            border-radius: 10px;
            margin-bottom: 10px;
            color: #595E62;
            display: flex;
            align-items: end;
            font-family: "Poppins", sans-serif;
            display: flex;
            flex-direction: row-reverse;
            justify-content: end;
            align-items: end;
        }

        .user-message .messageWrapper div {
            border: none;
            border-radius: 10px;
            max-width: 250px;
            width: max-content;
            padding: 10px;
            border-bottom-right-radius: 0px;
            margin-right: 0px;
            font-size: 12px;
            background-color: #F4F9FF;
            display: flex !important;
            justify-content: end !important;
            text-align: start !important;
        }

        .user-message .message-image {
            display: none;
        }

        /* .user-message div p{
      width: 100%;
    } */
        .user-message .messageWrapper {
            padding-right: 10px;
            text-align: end;
            align-self: end !important;
        }

        .user-message .messageWrapper .botname-message {
            padding-right: 10px;
            text-align: end;
            align-self: end !important;
        }

        .background {
            background: transparent;
        }

        #response {
            width: 100%;
            padding: 0px;
            background-color: #fff;
            border-radius: 25px;
            height: 350px;
            overflow: auto;
            position: relative;
            font-family: "Poppins", sans-serif;
            font-size: 12px;

            /* Hide scrollbar for WebKit browsers */
            scrollbar-width: none;
            /* Firefox */
            -ms-overflow-style: none;
            /* Internet Explorer 10+ */
        }

        #response::-webkit-scrollbar {
            display: none;
        }

        .message-image {
            width: 30px;
            height: 30px;
            margin-right: 10px;
            margin-top: 10px;
            border-radius: 50%;
        }

        .chat-submit-button {
            position: absolute;
            right: 10px;
            bottom: 10px;
            background-color: transparent;
            border-radius: 100%;
            color: #1C73D4;
            /* color: #BFBFBF; */
            padding: 10px;
            font-size: 20px;
            line-height: 20px;
            font-family: "Poppins", sans-serif;
            border: solid 1px #1C73D4;
        }

        .chat-submit-button:hover {
            background-color: transparent;
        }

        #questionForm {
            position: relative;
            padding: 10px;
            padding-top: 0px;
        }

        .chat-header {
            background-color: #1C73D4;
            border-top-left-radius: 8px;
            border-top-right-radius: 8px;
        }

        .chat-container {
            padding: 10px;
        }

        .chat-input {
            line-height: 30px;
            border-radius: 0px;
            font-family: "Poppins", sans-serif;
            font-size: 12px;
            padding-right: 45px !important;
            border: none !important;
        }

        .chat-input:focus {
            outline: none !important;
            box-shadow: none
        }

        .chat-input::placeholder {
            font-family: "Poppins", sans-serif;
            font-size: 12px;
            color: #BFBFBF;
        }

        .language-buttons button {
            font-family: "Poppins", sans-serif;
            font-size: 12px;
            border-radius: 15px;
            background-color: #2a0e45;
            border: none;
            color: #fff;
            width: 100%;
            padding-top: 5px;
            padding-bottom: 5px;
        }

        @media screen and (max-width: 600px) {
            .background {
                padding: 5px !important;
                margin-top: 10px;
            }

            .container {
                width: 100% !important;
                margin: 10px;
                position: relative !important;
                border: none;
                border-radius: 8px;
                height: 99vh;
            }

            #response {
                width: 100%;
                height: calc(100svh - 220px) !important;
            }

            #questionForm {
                position: relative;
                bottom: 0;
                width: 100%;
                padding: 10px;
                padding-top: 0px;
            }
        }

        .closeButton {
            background-color: transparent;
            border: none;
            border-radius: 100%;
            font-size: 16px;
            line-height: 16px;
            width: 25px;
            height: 25px;
            color: #fff;
            margin-right: 20px;
            text-align: center;
            padding: 0px;

        }

        @keyframes fadeIn {
            0% {
                opacity: 0;
            }

            50% {
                opacity: 0.5;
            }

            100% {
                opacity: 1;
            }
        }

        @keyframes visible {
            0% {
                visibility: hidden;
            }

            100% {
                visibility: visible;
            }
        }

        .loading {
            animation: fadeIn 0.5s ease-in-out infinite alternate, visible 0.5s ease-in-out infinite alternate;
        }

        .typingmsg-wrapper {
            background-color: #fff;
            color: #000;
        }

        .typing-msg {
            color: #000;
            font-size: 25px;
            padding: 5px !important;
        }

        .error-message {
            background-color: #2a0e459c;
            color: #fff;
            padding: 10px;
            border-radius: 10px !important;
            margin-top: 10px;
        }


        #questionButtons button {
            margin-bottom: 10px;
        }



        .chatDetails p {
            color: #fff;
            font-weight: 600;
            font-size: 18px;
            font-family: "Poppins", sans-serif;
        }

        .chatDetails span {
            color: #fff;
            font-weight: 300;
            font-size: 11px;
            font-family: "Poppins", sans-serif;
        }

        .botname-message {
            color: #BFBFBF;
            font-weight: 400;
            font-size: 10px;
            font-family: "Poppins", sans-serif;
        }

        .quickQuestionButton {
            background-color: #1C73D4;
            border-radius: 5px;
            border: none;
            color: #fff;
            font-weight: 400;
            font-size: 12px;
            font-family: "Poppins", sans-serif;
            padding: 8px;
            text-align: start;
        }

        .quickQuestionButton i {
            font-size: 20px;
            padding-left: 10px;
        }

        .powerdTextBox {
            background-color: #f7f7f7;
            border-radius: 4px;
        }

        .powerdTextBox p {
            color: #BFBFBF;
            font-weight: 300;
            font-size: 12px;
            font-family: "Poppins", sans-serif;
        }

        .powerdTextBox span {
            color: #1C73D4;
            font-weight: 600;
        }

        .liveagentBtn {
            background-color: #fff;
            border-radius: 5px;
            border: none;
            color: #1C73D4;
            font-weight: 400;
            font-size: 12px;
            font-family: "Poppins", sans-serif;
            padding: 8px;
            text-align: center;
        }
        .btnNotoClose, .btnYesToClose{
            background-color: #1C73D4;
            border-radius: 5px;
            border: none;
            color: #fff;
            font-weight: 400;
            font-size: 12px;
            font-family: "Poppins", sans-serif;
            padding: 8px;
            text-align: center;
        }
        .messageSubmitForm{

        }
    </style>
</head>

<body class="background">
    <div class="container shadow-lg my-0 p-0">
        <div class="d-flex chat-header w-100 py-2 text-center justify-content-between align-items-center">
            <div class="d-flex flex-row">
                <div class="d-flex ps-3 pe-2 py-1 position-relative">
                    <img src="/agent.png" alt="" class="" style="height: 60px; width: auto;">
                    <span class="position-absolute start-100 translate-middle p-1 rounded-circle"
                        style="background-color: rgb(5, 233, 5); bottom: 0; margin-left: -20px !important;">
                        <span class="visually-hidden">New alerts</span>
                    </span>
                </div>
                <div class="d-flex flex-column chatDetails align-items-start justify-content-center">
                    <p class="mb-0">Thyaga Assistant</p>
                    <span class="mb-0">Online</span>
                </div>
            </div>
            <button class="closeButton"><i class="bi bi-x-lg"></i></button>
        </div>

        <div class="d-flex chat-container">
            <div id="response" class="">
                <div class="d-flex justify-content-center align-items-center">
                    <!-- <img src="../chat-logo.webp" alt="" class="px-3 py-2 mb-3"> -->
                </div>
                <div class="bot-message">
                    <img class="message-image" src="/agent.png">

                    <div class="messageWrapper">
                        <span class="botname-message" id="OpenedTime1">ChatBot</span>
                        <div>
                            <p class="mb-0">Hi, How can I help you today!</p>
                        </div>
                    </div>
                </div>
                <div class="bot-message">
                    <img class="message-image" src="/agent.png">

                    <div class="messageWrapper">
                        <span class="botname-message" id="OpenedTime2"></span>
                        <div>
                            <p class="mb-0">Here's few ways to start with us.</p>
                        </div>
                        <span id="questionButtons" class="d-flex flex-column w-100 p-0 m-0 mt-2">

                        </span>
                    </div>
                </div>
            </div>
        </div>
        <form id="questionForm" style="border-top: solid 1px #e0e0e0; padding-top: 10px;">
            <input class="form-control chat-input" placeholder="Write message here..." id="question" name="question"
                required></input>
            <button type="submit" class="btn btn-light btn-lg chat-submit-button"><i
                    class="bi bi-send-fill"></i></button>
        </form>
        <div class="d-flex px-3 pt-0 pb-2 w-100 justify-content-center align-items-center">
            <div class="d-flex flex-row py-2 powerdTextBox text-center w-100 justify-content-center align-items-center">
                <p class="mb-0">Powered By : <span>KodeTech</span></p>
            </div>
        </div>
    </div>


    <script>


        var quickQuestions = [];
<% for (var i = 0; i < questions.length; i++) { %>
            quickQuestions.push({
                question: "<%= questions[i].question %>",
                answer: "<%= questions[i].answer %>"
            });
<% } %>

var questionButtonsContainer = document.getElementById("questionButtons");

        quickQuestions.forEach(function (qa) {
            var button = document.createElement("button");
            button.classList.add('quickQuestionButton', 'my-1');
            button.innerHTML = `
        <span class="d-flex flex-row justify-content-between align-items-center"> 
          <span>${qa.question}</span> 
          <i class="bi bi-arrow-right-square-fill"></i>
        </span>
    `;
            button.addEventListener("click", function () {
                // Add the clicked question as a user message to the chat history
                // chatHistory.push({ role: 'user', content: qa.question });

                // Display the user's question
                appendMessageToResponse('quickQuestion', qa.question);
                // Display the corresponding answer
                appendMessageToResponse('quickAnswer', qa.answer);
            });
            questionButtonsContainer.appendChild(button);
        });

        // quick questions ============================================================


        function setFormattedOpenedTime() {
    const OpenedTime = new Date();
    let Opendhours = OpenedTime.getHours();
    const Openedminutes = OpenedTime.getMinutes().toString().padStart(2, '0');
    const Openedseconds = OpenedTime.getSeconds().toString().padStart(2, '0');
    const Openedampm = Opendhours >= 12 ? 'PM' : 'AM';
    Opendhours = Opendhours % 12;
    Opendhours = Opendhours ? Opendhours : 12; // the hour '0' should be '12'
    const formattedOpenedTime = `${Opendhours.toString().padStart(2, '0')}:${Openedminutes} ${Openedampm}`;

    document.getElementById('OpenedTime2').textContent = formattedOpenedTime;
}

// Call the function to set the time
setFormattedOpenedTime();



// Define global variables
let chatHistory = [];
let messageDiv;
let chatWithAgent = false;
let chatTimeoutId;
let endChatAlertShown = false;

// Event listener to clear localStorage items on browser refresh
window.addEventListener("beforeunload", function (event) {
    localStorage.removeItem("selectedLanguage");
    localStorage.removeItem("chatId");
});

// Function to initialize typing animation
function showTypingAnimation() {
    const responseDiv = document.getElementById("response");
    const typingMessage = document.createElement("div");
    typingMessage.classList.add("bot-message");
    typingMessage.innerHTML = `
            <div class="typing-animation typingmsg-wrapper">
                <i class="bi bi-three-dots loading typing-msg"></i>
            </div>
            `;
    responseDiv.appendChild(typingMessage);
    responseDiv.scrollTop = responseDiv.scrollHeight;
}

// Function to remove typing animation
function hideTypingAnimation() {
    const typingMessage = document.querySelector(".typing-animation");
    if (typingMessage) {
        typingMessage.remove();
    }
}

// Function to handle error messages
function handleErrorMessage(error) {
    const responseDiv = document.getElementById("response");
    let errorMessage =
        "<p class='error-message'>The allocated number of tokens are over, please ask the administrator to add more tokens to the system.</p>"; // Default error message

    // Check if the error message matches the specific error condition
    if (
        error.message ===
        "The allocated number of tokens are over, please ask the administrator to add more tokens to the system."
    ) {
        errorMessage =
            "<p>The allocated number of tokens are over, please ask the administrator to add more tokens to the system.</p>";
    }
    responseDiv.innerHTML = errorMessage;
}

// Function to start chat timeout
function startChatTimeout() {
    chatTimeoutId = setTimeout(showEndChatAlert, 150000);
}

// Function to reset chat timeout
function resetChatTimeout() {
    clearTimeout(chatTimeoutId);
    startChatTimeout();
}

// Function to show end chat alert
function showEndChatAlert() {
    if (!endChatAlertShown) {
        // Check if the alert has not been shown
        endChatAlertShown = true; // Set the flag to true to indicate the alert has been shown

        const responseDiv = document.getElementById("response");
        const alertDiv = document.createElement("div");
        alertDiv.classList.add(
            "alert",
            "alert-warning",
            "alert-dismissible",
            "fade",
            "show"
        );
        alertDiv.setAttribute("role", "alert");
        alertDiv.innerHTML = `
            It seems you haven't sent a message for a while. Do you want to end the chat?
            <div class="d-flex flex-row">
              <button type="button" class="btnYesToClose btn-end-chat">Yes</button>
              <button type="button" class="btnNotoClose ms-2" data-bs-dismiss="alert">Cancel</button>
            </div>
        `;
        responseDiv.appendChild(alertDiv);
        alertDiv.scrollIntoView({ behavior: "smooth" });

        // Add event listener for the "Yes" button
        const endChatButton = alertDiv.querySelector(".btn-end-chat");
        endChatButton.addEventListener("click", handleEndChat);
    }
}

// Function to handle ending the chat
function handleEndChat() {
    // Clear the chat timeout
    clearTimeout(chatTimeoutId);

    // Show star rating form message
    appendMessageToResponse(
        "bot",
        "Please rate your chat experience:",
        null,
        true
    );
}

// Function to append message to response div
function appendMessageToResponse(role, content, data, isRatingForm = false) {
    const responseDiv = document.getElementById("response");
    const messageDiv = createMessageDiv(role, content);
    const image = createMessageImage(role);

    if (isList(content)) {
        appendListContent(messageDiv, content);
    } else if (content.includes("I'm sorry.. no information documents found for data retrieval.")) {
        appendLiveAgentContent(messageDiv, content, data);
    }
    
    else {
        appendPlainTextContent(messageDiv, content);
    }

    if (isRatingForm) {
        appendRatingForm(messageDiv);
    }

    resetChatTimeout();

    messageDiv.prepend(image);
    responseDiv.appendChild(messageDiv);
    responseDiv.scrollTop = responseDiv.scrollHeight;
}

// function createMessageDiv(role, content) {
//     const messageDiv = document.createElement("div");
//     messageDiv.classList.add(role === "user" ? "user-message" : "bot-message");
//     return messageDiv;
// }
function createMessageDiv(role, content) {
    const messageDiv = document.createElement("div");

    // Add class based on the role
    if (role === "user") {
        messageDiv.classList.add("user-message");
    } else if (role === "bot") {
        messageDiv.classList.add("bot-message");
    } else if (role === "product") {
        messageDiv.classList.add("product-message");
    }else if(role === 'quickQuestion'){
        messageDiv.classList.add("user-message"); 
    }else if(role === 'quickAnswer'){
        messageDiv.classList.add("bot-message"); 
    }else if(role === 'liveagent'){
        messageDiv.classList.add("bot-message"); 
    }

    // quick questions ============================================================
    // if (role === 'quickQuestion') {
    //     messageDiv.classList.add("user-message"); // Apply user message style
    //   } else if (role === 'quickAnswer') {
    //     messageDiv.classList.add("bot-message"); // Apply bot message style
    //   } else {
    //     messageDiv.classList.add(role === 'user' ? "user-message" : "bot-message");
    //   }

    // Optionally, add the content to the messageDiv
    messageDiv.textContent = content;

    return messageDiv;
}


function createMessageImage(role) {
    const image = document.createElement("img");
    image.classList.add("message-image");
    image.src = role === "user" ? "/user.webp" : "/agent.png";
    return image;
}

function isList(content) {
    const listRegex = /^\d+\.\s.*$/gm;
    return listRegex.test(content);
}

function appendListContent(messageDiv, content) {

    const currentTime = new Date();
    let hours = currentTime.getHours();
    const minutes = currentTime.getMinutes().toString().padStart(2, '0');
    const seconds = currentTime.getSeconds().toString().padStart(2, '0');
    const ampm = hours >= 12 ? 'PM' : 'AM';
    hours = hours % 12;
    hours = hours ? hours : 12; // the hour '0' should be '12'
    const formattedTime = `${hours.toString().padStart(2, '0')}:${minutes} ${ampm}`;

    const listItems = content.split("\n").map(item => `<li style="margin-bottom: 10px !important;">${item}</li>`).join("");
    messageDiv.innerHTML = `<div class="messageWrapper">
    <span class="botname-message">${formattedTime}</span>
    <div>
      <ul style="list-style: none; padding: 0px !important">${listItems}</ul>
    </div>
  </div>`;
}

function appendLiveAgentContent(messageDiv, content, data) {

    const currentTime = new Date();
    let hours = currentTime.getHours();
    const minutes = currentTime.getMinutes().toString().padStart(2, '0');
    const seconds = currentTime.getSeconds().toString().padStart(2, '0');
    const ampm = hours >= 12 ? 'PM' : 'AM';
    hours = hours % 12;
    hours = hours ? hours : 12; // the hour '0' should be '12'
    const formattedTime = `${hours.toString().padStart(2, '0')}:${minutes} ${ampm}`;


    messageDiv.innerHTML = `<div class="messageWrapper">
    <span class="botname-message">${formattedTime}</span>
    <div class="d-flex flex-column">
        <button id="LiveAgentButton" class="liveagentBtn">Chat with live agent</button>
      <div>${content}</div>
    </div>
  </div>
      `;
    const liveAgentButton = messageDiv.querySelector("#LiveAgentButton");
    liveAgentButton.addEventListener("click", handleLiveAgentButtonClick(data));
}

function handleLiveAgentButtonClick(data) {
    return async function () {
        try {
            const switchResponse = await fetch("/switch-to-live-agent", {
                method: "POST",
                headers: {
                    "Content-Type": "application/json",
                },
                body: JSON.stringify({ chatId: data.chatId }),
            });
            console.log("switch : ", switchResponse)
            if (switchResponse.ok) {
                showAlert("One of our agents will join you soon. Please stay tuned.");
                startCheckingForAgent(data);
                // showOfflineForm();
            } else {
                // Show offline form
                showOfflineForm();
            }
        } catch (error) {
            console.error("Error switching to live agent:", error);
        }
    };
}

function showOfflineForm() {
    const responseDiv = document.getElementById("response");
    const offlineForm = document.createElement("div");
    offlineForm.innerHTML = `
        <div class='bot-message'>
            <div class="p-2 messageSubmitForm">
            <div>Our agents are offline. Please submit your message:</div>
            <form id="offlineForm">
                <div class="mb-3">
                    <label for="name" class="form-label">Name</label>
                    <input type="text" class="form-control" id="name" required>
                </div>
                <div class="mb-3">
                    <label for="email" class="form-label">Email</label>
                    <input type="email" class="form-control" id="email" required>
                </div>
                <div class="mb-3">
                    <label for="subject" class="form-label">Subject</label>
                    <input type="text" class="form-control" id="subject" required>
                </div>
                <div class="mb-3">
                    <label for="message" class="form-label">Message</label>
                    <textarea class="form-control" id="message" rows="3" required></textarea>
                </div>
                <button type="submit" class="btnNotoClose">Submit</button>
            </form>
        </div>
    </div>
    `;
    responseDiv.appendChild(offlineForm);

    // Scroll to the form
    offlineForm.scrollIntoView({ behavior: "smooth", block: "end" });

    // Add event listener for form submission
    const offlineFormElement = document.getElementById("offlineForm");
    offlineFormElement.addEventListener("submit", handleOfflineFormSubmission);
}


async function handleOfflineFormSubmission(event) {
    event.preventDefault();

    const chatId = localStorage.getItem("chatId");
    const name = document.getElementById("name").value;
    const email = document.getElementById("email").value;
    const subject = document.getElementById("subject").value;
    const message = document.getElementById("message").value;

    try {
        const response = await fetch("/live-chat-offline-form", {
            method: "POST",
            headers: {
                "Content-Type": "application/json",
            },
            body: JSON.stringify({ chatId, name, email, subject, message }),
        });

        if (response.ok) {
            showAlert("Your message has been submitted successfully. Our team will get back to you soon.");
        } else {
            showAlert("Failed to submit your message. Please try again later.");
        }
    } catch (error) {
        console.error("Error submitting offline form:", error);
        showAlert("An error occurred while submitting your message. Please try again later.");
    }
}


function startCheckingForAgent(data) {
    let intervalId;
    let agentJoined = false;

    intervalId = setInterval(async () => {
        try {
            const response = await fetch("/live-chat-agent", {
                method: "POST",
                headers: {
                    "Content-Type": "application/json",
                },
                body: JSON.stringify({ chatId: data.chatId }),
            });

            if (response.ok) {
                const responseData = await response.json();
                if (responseData.agent_id !== "unassigned") {
                    if (!agentJoined) {
                        showAlert("Now you are chatting with agent ID: " + responseData.agent_name);
                        agentJoined = true;
                        chatWithAgent = true;
                    }
                    appendMessageToResponse("liveagent", responseData.agent_message, data);
                }
            }
        } catch (error) {
            console.error("Error fetching products data:", error);
        }
    }, 5000);

    setTimeout(() => {
        clearInterval(intervalId);
        if (!agentJoined) {
            showAlert("All agents are busy. Please try again later.");
            console.log("No agents available. API call stopped.");
        }
    }, 120000);
}




function appendPlainTextContent(messageDiv, content) {
    const currentTime = new Date();
    let hours = currentTime.getHours();
    const minutes = currentTime.getMinutes().toString().padStart(2, '0');
    const seconds = currentTime.getSeconds().toString().padStart(2, '0');
    const ampm = hours >= 12 ? 'PM' : 'AM';
    hours = hours % 12;
    hours = hours ? hours : 12; // the hour '0' should be '12'
    const formattedTime = `${hours.toString().padStart(2, '0')}:${minutes} ${ampm}`;

    messageDiv.innerHTML = `<div class="messageWrapper">
        <span class="botname-message">${formattedTime}</span>
        <div>
          <p class="mb-0">${content}</p>
        </div>
      </div>`;
}

function appendRatingForm(messageDiv) {
    const ratingFormHTML = `
      <div class="star-rating-form d-flex flex-column" style="margin-bottom: 10px;">
        <label for="rating">Rate your experience:</label>
        <div class="rating-icons" style="border: none !important;">
          <i class="bi bi-star rating-icon"></i>
          <i class="bi bi-star rating-icon"></i>
          <i class="bi bi-star rating-icon"></i>
          <i class="bi bi-star rating-icon"></i>
          <i class="bi bi-star rating-icon"></i>
        </div>
        <input type="hidden" id="rating" name="rating" value="0">
        <textarea type="text" id="feedbackMessage" name="feedbackMessage" class="feedbackMessage"></textarea>
        <button id="submitRatingButton" class="btnNotoClose">Submit</button>
      </div>
    `;
    messageDiv.innerHTML += ratingFormHTML;
    addRatingIconEventListeners(messageDiv);
}

function addRatingIconEventListeners(messageDiv) {
    const ratingIcons = messageDiv.querySelectorAll(".rating-icon");
    ratingIcons.forEach((icon, index) => {
        icon.addEventListener("click", handleRatingIconClick(messageDiv, index));
    });
}

function handleRatingIconClick(messageDiv, index) {
    return function () {
        const ratingInput = messageDiv.querySelector("#rating");
        ratingInput.value = index + 1;
        const ratingIcons = messageDiv.querySelectorAll(".rating-icon");
        ratingIcons.forEach((star, i) => {
            star.classList.toggle("bi-star-fill", i <= index);
        });
    };
}

function showAlert(message) {
    const responseDiv = document.getElementById("response");
    const alertDiv = document.createElement("div");
    alertDiv.classList.add("alert", "alert-warning", "alert-dismissible", "fade", "show", "me-2");
    alertDiv.setAttribute("role", "alert");
    alertDiv.innerHTML = `
      ${message}
      <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
    `;
    responseDiv.appendChild(alertDiv);
    alertDiv.scrollIntoView({ behavior: "smooth" });
}



function appendLanguageMessage(content) {
    const responseDiv = document.getElementById("response");
    const messageDiv = document.createElement("div");
    messageDiv.classList.add("bot-message");

    // Create an image element for the message
    const image = document.createElement("img");
    image.classList.add("message-image");
    image.src = "/agent.png";

    const currentTime = new Date();
    let hours = currentTime.getHours();
    const minutes = currentTime.getMinutes().toString().padStart(2, '0');
    const seconds = currentTime.getSeconds().toString().padStart(2, '0');
    const ampm = hours >= 12 ? 'PM' : 'AM';
    hours = hours % 12;
    hours = hours ? hours : 12; // the hour '0' should be '12'
    const formattedTime = `${hours.toString().padStart(2, '0')}:${minutes} ${ampm}`;

    // Use innerHTML to allow HTML formatting in the message
    messageDiv.innerHTML = `<div class="messageWrapper">
    <span class="botname-message">${formattedTime}</span>
    <div>
      <p class="mb-0">${content}</p>
    </div>
  </div>`;
    messageDiv.prepend(image);

    responseDiv.appendChild(messageDiv);
    // Scroll down to the latest message
    responseDiv.scrollTop = responseDiv.scrollHeight;
}

// Event listener for question form submission
document
    .getElementById("questionForm")
    .addEventListener("submit", async function (event) {
        event.preventDefault();
        const questionInput = document.getElementById("question");
        const question = questionInput.value;

        document.getElementById("question").value = "";

        const selectedLanguage = localStorage.getItem("selectedLanguage");
        // Add the user's question to the chat history
        chatHistory.push({ role: "user", content: question });

        appendMessageToResponse("user", question);

        let chatId = localStorage.getItem("chatId");
        console.log("generated chat id : ", chatId);
        const requestBody = {
            chatId: chatId,
            messages: chatHistory,
            language: selectedLanguage || "English",
        };
        const requestBodyAgent = {
            chatId: chatId,
            user_message: question,
            language: selectedLanguage || "English",
        };

        console.log("requestBody : ", requestBody);

        if (chatWithAgent === false) {
            // Display the user's message immediately
            // Change button icon to three dots
            const submitButton = document.querySelector(".chat-submit-button");
            submitButton.innerHTML = '<i class="bi bi-three-dots loading"></i>';
            submitButton.disabled = true;

            // Disable input field
            questionInput.disabled = true;
            // Show typing animation
            showTypingAnimation();


            const currentTime = new Date();
            let hours = currentTime.getHours();
            const minutes = currentTime.getMinutes().toString().padStart(2, '0');
            const seconds = currentTime.getSeconds().toString().padStart(2, '0');
            const ampm = hours >= 12 ? 'PM' : 'AM';
            hours = hours % 12;
            hours = hours ? hours : 12;
            const formattedTime = `${hours.toString().padStart(2, '0')}:${minutes} ${ampm}`;


            try {
                const response = await fetch("/api/chat-response", {
                    method: "POST",
                    headers: {
                        "Content-Type": "application/json",
                    },
                    body: JSON.stringify(requestBody),
                });

                const data = await response.json();

                // Update the chat history for future interactions
                chatHistory = data.chatHistory || [];
                console.log("chatId : ", data.chatId);

                if (!localStorage.getItem("chatId")) {
                    localStorage.setItem("chatId", data.chatId);
                }
                if (data.answer !== null) {
                    appendMessageToResponse("bot", data.answer, data);
                }

                // Hide typing animation
                hideTypingAnimation();
                // Clear the question input
                questionInput.value = "";
                submitButton.innerHTML = '<i class="bi bi-send"></i>';
                submitButton.disabled = false;
            } catch (error) {
                console.error("Error submitting question:", error);
                // Handle specific error message
                handleErrorMessage(error);
            } finally {
                // Enable input field
                questionInput.disabled = false;
            }
        } else {
            const responseLiveAgent = await fetch("/live-chat-user", {
                method: "POST",
                headers: {
                    "Content-Type": "application/json",
                },
                body: JSON.stringify(requestBodyAgent),
            });

            const liveAgentData = await responseLiveAgent.json();
            chatHistory = liveAgentData.chatHistory || []; // Update chat history

            // Append the response to the response div

            checkForAgent();
            // Hide typing animation
            // hideTypingAnimation();

            // Clear the question input
            questionInput.value = "";

            // Change button icon back to send icon
            // submitButton.innerHTML = '<i class="bi bi-send"></i>';

            // Enable the submit button
            // submitButton.disabled = false;
        }
    });








// Event listener for language change to English
document
    .getElementById("changeToEnglishButton")
    .addEventListener("click", function () {
        localStorage.setItem("selectedLanguage", "English");
        appendLanguageMessage("Please ask your question in English.");
    });

// Event listener for language change to Sinhala
document
    .getElementById("changeToSinhalaButton")
    .addEventListener("click", function () {
        localStorage.setItem("selectedLanguage", "Sinhala");
        appendLanguageMessage("කරුණාකර ඔබේ ප්‍රශ්නය සිංහලෙන් අසන්න.");
    });

// Event listener for language change to Tamil
document
    .getElementById("changeToTamilButton")
    .addEventListener("click", function () {
        localStorage.setItem("selectedLanguage", "Tamil");
        appendLanguageMessage("உங்கள் கேள்வியை தமிழில் கேளுங்கள்.");
    });

// Function to handle rating submission
async function handleRatingSubmission() {
    const ratingInput = document.getElementById("rating");
    const rating = ratingInput.value;
    const feedbackMessageInput = document.getElementById("feedbackMessage");
    const feedbackMessage = feedbackMessageInput.value;
    const chatId = localStorage.getItem("chatId");

    try {
        const response = await fetch("/save-rating", {
            method: "POST",
            headers: {
                "Content-Type": "application/json",
            },
            body: JSON.stringify({
                ratingValue: rating,
                feedbackMessage: feedbackMessage,
                chatId: chatId,
            }),
        });

        if (response.ok) {
            // Show thank you message for feedback
            const responseDiv = document.getElementById("response");
            const thankYouDiv = document.createElement("div");
            thankYouDiv.classList.add(
                "alert",
                "alert-success",
                "alert-dismissible",
                "fade",
                "show"
            );
            thankYouDiv.setAttribute("role", "alert");
            thankYouDiv.textContent = "Thank you for your feedback!";
            responseDiv.appendChild(thankYouDiv);
            thankYouDiv.scrollIntoView({ behavior: "smooth" });
        }
    } catch (error) {
        console.error("Error submitting rating:", error);
        // Handle error
    }
}

// Add event listeners for the rating icons
function addRatingIconEventListeners(messageDiv) {
    const ratingIcons = messageDiv.querySelectorAll(".rating-icon");
    ratingIcons.forEach((icon, index) => {
        icon.addEventListener("click", () => {
            // Set the rating value based on the index of the clicked star icon
            const ratingInput = document.getElementById("rating");
            ratingInput.value = index + 1;

            // Highlight the selected star and unhighlight the rest
            ratingIcons.forEach((star, i) => {
                if (i <= index) {
                    star.classList.add("bi-star-fill");
                    star.classList.remove("bi-star");
                } else {
                    star.classList.remove("bi-star-fill");
                    star.classList.add("bi-star");
                }
            });
        });
    });
}

// Call the function with messageDiv when it's available
addRatingIconEventListeners(messageDiv);


    </script>
</body>

</html>